<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Apparel Machinery Premium | Industrial Equipment</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* ... (all existing CSS remains exactly the same) ... */
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <!-- ... (top bar content remains the same) ... -->
    </div>

    <div class="firebase-status status-offline" id="firebaseStatus">
      <i class="fas fa-wifi"></i> Working in offline mode. Some features may be limited.
    </div>

    <!-- Admin Panel (initially hidden) -->
    <div class="admin-panel" id="adminPanel">
      <!-- ... (admin panel content remains the same) ... -->
    </div>

    <!-- Customer Dashboard (initially hidden) -->
    <div class="dashboard" id="customerDashboard">
      <!-- ... (customer dashboard content remains the same) ... -->
    </div>

    <div class="banner-section">
      <img src="https://images.unsplash.com/photo-1497366811353-6870744d04b2?ixlib=rb-4.0.3&auto=format&fit=crop&w=1500&q=80" alt="Industrial Equipment Banner" class="banner-image" id="bannerImage">
      <div class="banner-overlay">
        <h1 id="bannerTitle">Apparel Machinery Premium</h1>
        <p id="bannerDescription">Your trusted partner for industrial sewing equipment</p>
      </div>
    </div>

    <div class="main-content">
      <!-- ... (main content remains the same) ... -->
    </div>
  </div>

  <!-- ... (modals and other HTML elements remain the same) ... -->

  <script>
    // ... (Firebase configuration remains the same) ...

    // Mock product data for offline use (prices in PKR)
    let mockProducts = [
      // ... (mock products remain the same) ...
    ];

    // ... (rest of the JavaScript code remains exactly the same) ...

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      // First try to load products from Firebase
      loadProductsFromFirebase().then(products => {
        if (products && products.length > 0) {
          displayProductsFromFirebase(products);
        } else {
          // If no products in Firebase, use mock data
          displayProducts();
        }
      }).catch(error => {
        console.error("Error loading from Firebase:", error);
        // Fall back to mock data
        displayProducts();
      });
      
      updateCart();
      
      // Try to load banner from Firebase
      loadBannerFromFirebase().then(bannerData => {
        if (bannerData) {
          if (bannerData.imageUrl) {
            bannerImage.src = bannerData.imageUrl;
          }
          if (bannerData.title) {
            bannerTitle.textContent = bannerData.title;
          }
          if (bannerData.description) {
            bannerDescription.textContent = bannerData.description;
          }
        }
      }).catch(error => {
        console.error("Error loading banner from Firebase:", error);
      });
    });

    // New function to load products from Firebase
    function loadProductsFromFirebase() {
      return new Promise((resolve, reject) => {
        if (!db) {
          reject("Firebase not available");
          return;
        }
        
        db.collection("products").get().then((querySnapshot) => {
          if (querySnapshot.empty) {
            resolve([]);
            return;
          }
          
          let products = [];
          querySnapshot.forEach((doc) => {
            const product = doc.data();
            product.id = doc.id;
            products.push(product);
          });
          resolve(products);
        }).catch((error) => {
          reject(error);
        });
      });
    }

    // New function to display products from Firebase
    function displayProductsFromFirebase(products, category = "all", searchTerm = "") {
      productsGrid.innerHTML = '';
      
      let filteredProducts = products;
      
      // Filter by category
      if (category !== "all") {
        filteredProducts = products.filter(product => product.category === category);
      }
      
      // Filter by search term
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filteredProducts = filteredProducts.filter(product => 
          product.title.toLowerCase().includes(term) ||
          product.description.toLowerCase().includes(term) ||
          product.code.toLowerCase().includes(term)
        );
      }
      
      if (filteredProducts.length === 0) {
        productsGrid.innerHTML = '<div class="cart-empty">No products found</div>';
        return;
      }
      
      filteredProducts.forEach(product => {
        renderProductCard(product);
      });
    }

    // New function to load banner from Firebase
    function loadBannerFromFirebase() {
      return new Promise((resolve, reject) => {
        if (!db) {
          reject("Firebase not available");
          return;
        }
        
        db.collection("banner").doc("current").get().then((doc) => {
          if (doc.exists) {
            resolve(doc.data());
          } else {
            resolve(null);
          }
        }).catch((error) => {
          reject(error);
        });
      });
    }

    // Modified saveProductBtn click handler to save to Firebase
    saveProductBtn.addEventListener('click', () => {
      const isEditMode = saveProductBtn.hasAttribute('data-edit-id');
      
      const productData = {
        title: document.getElementById('productTitle').value,
        code: document.getElementById('productCode').value,
        manufacturer: document.getElementById('productManufacturer').value,
        description: document.getElementById('productDescription').value,
        condition: document.getElementById('productCondition').value,
        category: document.getElementById('productCategory').value,
        image: document.getElementById('productImage').value,
        price: parseInt(document.getElementById('productPrice').value)
      };
      
      if (db) {
        // Try to save to Firebase
        if (isEditMode) {
          // Update existing product in Firebase
          const productId = saveProductBtn.dataset.editId;
          db.collection("products").doc(productId).update(productData)
            .then(() => {
              showNotification('Product updated successfully in Firebase!');
              // Remove edit mode
              saveProductBtn.removeAttribute('data-edit-id');
              saveProductBtn.innerHTML = '<i class="fas fa-save"></i> Save Product';
              
              // Reload products from Firebase
              loadProductsFromFirebase().then(products => {
                if (products && products.length > 0) {
                  displayProductsFromFirebase(products, currentCategory, currentSearchTerm);
                }
              });
            })
            .catch((error) => {
              console.error("Error updating product in Firebase:", error);
              showNotification('Error updating product in Firebase. Using local data.', true);
              // Fall back to local update
              updateProductLocally(productId, productData);
            });
        } else {
          // Add new product to Firebase
          db.collection("products").add(productData)
            .then((docRef) => {
              showNotification('Product added successfully to Firebase!');
              
              // Reload products from Firebase
              loadProductsFromFirebase().then(products => {
                if (products && products.length > 0) {
                  displayProductsFromFirebase(products, currentCategory, currentSearchTerm);
                }
              });
            })
            .catch((error) => {
              console.error("Error adding product to Firebase:", error);
              showNotification('Error adding product to Firebase. Using local data.', true);
              // Fall back to local add
              addProductLocally(productData);
            });
        }
      } else {
        // Firebase not available, use local data
        if (isEditMode) {
          updateProductLocally(saveProductBtn.dataset.editId, productData);
        } else {
          addProductLocally(productData);
        }
      }
      
      // Reset form
      document.getElementById('productTitle').value = '';
      document.getElementById('productCode').value = '';
      document.getElementById('productManufacturer').value = '';
      document.getElementById('productDescription').value = '';
      document.getElementById('productCondition').value = 'new';
      document.getElementById('productCategory').value = 'Management';
      document.getElementById('productImage').value = '';
      document.getElementById('productPrice').value = '';
      
      productForm.style.display = 'none';
    });

    // Helper function to update product locally
    function updateProductLocally(productId, productData) {
      const index = mockProducts.findIndex(p => p.id == productId);
      
      if (index !== -1) {
        mockProducts[index] = {
          id: parseInt(productId),
          ...productData
        };
        
        showNotification('Product updated successfully!');
        
        // Remove edit mode
        saveProductBtn.removeAttribute('data-edit-id');
        saveProductBtn.innerHTML = '<i class="fas fa-save"></i> Save Product';
        
        // Update the display
        displayProducts(currentCategory, currentSearchTerm);
      }
    }

    // Helper function to add product locally
    function addProductLocally(productData) {
      const newProduct = {
        id: mockProducts.length > 0 ? Math.max(...mockProducts.map(p => p.id)) + 1 : 1,
        ...productData
      };
      
      // Add to mock products
      mockProducts.push(newProduct);
      showNotification('Product added successfully!');
      
      // Update the display
      displayProducts(currentCategory, currentSearchTerm);
    }

    // Modified saveBannerBtn click handler to save to Firebase
    saveBannerBtn.addEventListener('click', () => {
      const bannerData = {
        imageUrl: document.getElementById('bannerImageUrl').value,
        title: document.getElementById('bannerTitle').value,
        description: document.getElementById('bannerDescription').value
      };
      
      if (db) {
        // Try to save to Firebase
        db.collection("banner").doc("current").set(bannerData)
          .then(() => {
            showNotification('Banner updated successfully in Firebase!');
            
            // Update the banner display
            if (bannerData.imageUrl) {
              bannerImage.src = bannerData.imageUrl;
            }
            if (bannerData.title) {
              bannerTitle.textContent = bannerData.title;
            }
            if (bannerData.description) {
              bannerDescription.textContent = bannerData.description;
            }
          })
          .catch((error) => {
            console.error("Error updating banner in Firebase:", error);
            showNotification('Error updating banner in Firebase. Using local update.', true);
            // Fall back to local update
            updateBannerLocally(bannerData);
          });
      } else {
        // Firebase not available, use local update
        updateBannerLocally(bannerData);
      }
      
      bannerForm.style.display = 'none';
    });

    // Helper function to update banner locally
    function updateBannerLocally(bannerData) {
      if (bannerData.imageUrl) {
        bannerImage.src = bannerData.imageUrl;
      }
      if (bannerData.title) {
        bannerTitle.textContent = bannerData.title;
      }
      if (bannerData.description) {
        bannerDescription.textContent = bannerData.description;
      }
      
      showNotification('Banner updated successfully!');
    }
  </script>
</body>
</html>